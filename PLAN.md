# План реализации FindOrigin

Поэтапный порядок действий по реализации Telegram-бота FindOrigin на основе спецификации PROJECT.md.

---

## Этап 1. Инициализация проекта

1.1. Создать Next.js-проект (App Router).

1.2. Добавить зависимости:
- `ai` или `openai` — для вызова AI
- Библиотека для работы с Telegram API (или `fetch` для прямых запросов)
- Парсер ссылок и извлечение метаданных из Telegram-постов

1.3. Настроить переменные окружения:
- `TELEGRAM_BOT_TOKEN` — токен бота
- `TELEGRAM_WEBHOOK_SECRET` — опционально для проверки подлинности
- `OPENAI_API_KEY` или ключ другого AI-провайдера

---

## Этап 2. Webhook-эндпоинт

2.1. Создать API Route: `app/api/telegram/webhook/route.ts` (POST).

2.2. Реализовать обработчик:
- Принимать POST с телом `update` от Telegram
- Извлекать `chat.id` и `text` из `update.message`
- При отсутствии `text` — обрабатывать вложения/ссылки (если есть)
- Возвращать **200 OK сразу** (без ожидания долгих операций)
- Запускать основную логику асинхронно (без блокировки ответа)

2.3. Настроить webhook в Telegram через `setWebhook` (вручную или скриптом).

---

## Этап 3. Обработка ввода

3.1. Определить формат ввода:
- Обычный текст — использовать напрямую
- Ссылка на Telegram-пост — различать `t.me/...` и `telegram.me/...`

3.2. Реализовать извлечение текста из ссылки на пост:
- Парсить URL и получать channel/chat + message_id
- Использовать Telegram API (getUpdates или Bot API) для получения текста поста
- Fallback: если API недоступен — попросить пользователя вставить текст

3.3. Сохранить исходный текст для дальнейшей обработки.

---

## Этап 4. Извлечение сущностей

4.1. Из текста выделить:
- ключевые утверждения (факты, тезисы)
- даты
- числа
- имена (персоны, организации)
- ссылки

4.2. Варианты реализации:
- Правила/регулярные выражения для дат, чисел, ссылок
- NER (Named Entity Recognition) через AI или библиотеки
- Комбинированный подход: regex + AI для сложных случаев

4.3. Сформировать структурированный набор «поисковых подсказок» для этапа поиска.

---

## Этап 5. на image.png

5.1. Определить стратегию поиска:
- Поиск через поисковый API (Google Custom Search, Bing, Serper и т.п.)
- Поиск по ключевым словам, утверждениям и сущностям

5.2. Ограничить типы источников:
- Официальные сайты (gov, org, официальные домены)
- Новостные сайты
- Блоги
- Научные/исследовательские публикации

5.3. Собрать кандидатов (5–10 URL) с заголовками и сниппетами.

---

## Этап 6. AI-анализ и ранжирование

6.1. Подготовить промпт для AI:
- Исходный текст/утверждение
- Список кандидатов (URL + заголовок + сниппет)
- Задача: сравнить **смысл**, а не буквальный текст
- Выход: 1–3 лучших источника + оценка уверенности (например, 0–100%)

6.2. Вызвать AI (OpenAI, Claude и т.д.).

6.3. Распарсить ответ и сформировать итоговый список источников.

---

## Этап 7. Отправка ответа пользователю

7.1. Форматировать результат:
- До 3 ссылок
- Краткое описание соответствия
- Оценка уверенности

7.2. Отправить сообщение через Telegram API `sendMessage`:
- Использовать `chat_id` из webhook
- Markdown или HTML для форматирования (если поддерживается)

7.3. Обработать ошибки (например, повторить отправку при сбое).

---

## Этап 8. Деплой и настройка

8.1. Настроить проект для Vercel:
- `vercel.json` при необходимости
- Проверить, что API Routes доступны по нужным путям

8.2. Задеплоить на Vercel.

8.3. Указать webhook URL: `https://<your-domain>/api/telegram/webhook`.

8.4. Протестировать полный цикл: ввод → извлечение → поиск → AI → ответ.

---

## Этап 9. Обработка краевых случаев

9.1. Пустой или некорректный ввод — сообщение с подсказкой.

9.2. Ссылка на пост без доступа — fallback на ручной ввод текста.

9.3. Поиск не дал результатов — вежливое сообщение об этом.

9.4. Ошибки AI или поиска — логирование и уведомление пользователя.

9.5. Rate limiting и защита webhook от флуда (опционально).

---

## Сводная последовательность

| # | Этап                            | Зависимости |
|---|---------------------------------|-------------|
| 1 | Инициализация проекта           | —           |
| 2 | Webhook-эндпоинт                | 1           |
| 3 | Обработка ввода                 | 2           |
| 4 | Извлечение сущностей            | 3           |
| 5 | Поиск источников                | 4           |
| 6 | AI-анализ и ранжирование        | 5           |
| 7 | Отправка ответа                 | 6           |
| 8 | Деплой на Vercel                | 7           |
| 9 | Краевые случаи и доработки      | 8           |
